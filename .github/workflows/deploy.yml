name: Deploy Docker to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout do código
    - name: Checkout code
      uses: actions/checkout@v3

    # Login no Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}  
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Build da imagem Dockers
    - name: Build Docker Image
      run: |
        docker build -t lucaslimabaseo/mao-amiga-deploy:latest . 

    # Push da imagem para o Docker Hub
    - name: Push Docker Image to Docker Hub
      run: |
        docker push lucaslimabaseo/mao-amiga-deploy:latest 

    # Deploy para VPS
    - name: Deploy to VPS
      env:
        HOST: ${{ secrets.VPS_HOST }}
        USER: ${{ secrets.VPS_USER }}
        PASSWORD: ${{ secrets.VPS_PASSWORD }}
      run: |
        # Conectar na VPS e realizar as ações de deploy
        sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USER@$HOST << EOF
          # Fazer logout e login no Docker Hub na VPS
          docker logout
          docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"

          # Parar e remover o container antigo
          docker stop mao-amiga-deploy || true
          docker rm mao-amiga-deploy || true

          # Remover imagens antigas para liberar espaço
          docker rmi lucaslimabaseo/mao-amiga-deploy:latest || true

          # Fazer pull da nova imagem
          docker pull lucaslimabaseo/mao-amiga-deploy:latest 

          # Rodar a nova imagem
          docker run -d --name mao-amiga-deploy -p 3002:3002 lucaslimabaseo/mao-amiga-deploy:latest  # Ajuste para usar a imagem da organização
        EOF
